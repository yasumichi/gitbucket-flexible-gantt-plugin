@(
    owner: String,
    repositoryName: String,
    issueId: Int,
    isEditable: Boolean
)(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
<hr>
<div class="panel panel-default">
    <div class="panel-heading">
        <i class="menu-icon octicon octicon-dashboard"></i>Flexible Gantt
        @if(isEditable) {
            <div class="pull-right">
                <i id="edit-gfg" class="menu-icon octicon octicon-pencil"></i>
            </div>
        }
    </div>
    <div class="panel-body">
        <form method="post" id="gfgform" action="@context.path/@owner/@repositoryName/issues/@issueId/period">
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Start</span>
                <div class="pull-right">
                    <input type="date" name="startDate" class="form-control input-sm custom-field-editor" value="" style="display: none;">
                    <span id="startDateText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">End</span>
                <div class="pull-right">
                    <input type="date" name="endDate" class="form-control input-sm custom-field-editor" value="" style="display: none;">
                    <span id="endDateText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Progress</span>
                <div class="pull-right">
                    <select class="form-control input-sm custom-field-editor" name="progress" style="display: none;">
                        <option>0</option>
                        <option>10</option>
                        <option>20</option>
                        <option>30</option>
                        <option>40</option>
                        <option>50</option>
                        <option>60</option>
                        <option>70</option>
                        <option>80</option>
                        <option>90</option>
                        <option>100</option>
                    </select>
                    <span id="progressText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Dependencies</span>
                <div class="pull-right">
                    <input type="text" name="dependencies" maxlength="100" value="" style="display: none;">
                    <span id="dependenciesText">Not Set</span>
                </div>
            </div>
            <div id="gfg-msg" class="alert" style="margin-bottom: 14px;display: none;"></div>
            <div style="margin-bottom: 14px;">
                <div class="pull-right">
                    <button class="btn btn-default btn-sm strong" id="gfgpost" type="button" style="display: none;">Update</button>
                    <button class="btn btn-default btn-sm strong" id="gfgcancel" type="button" style="display: none;">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    const editgfg = document.querySelector("#edit-gfg");
    const startDate = document.querySelector("input[name='startDate']");
    const startDateText = document.querySelector("#startDateText");
    const endDate = document.querySelector("input[name='endDate']");
    const endDateText = document.querySelector("#endDateText");
    const progress = document.querySelector("select[name='progress']");
    const progressText = document.querySelector("#progressText");
    const dependencies = document.querySelector("input[name='dependencies']");
    const dependenciesText = document.querySelector("#dependenciesText");
    const gfgmsg = document.querySelector("#gfg-msg");
    const gfgpost = document.querySelector("#gfgpost");
    const gfgcancel = document.querySelector("#gfgcancel");

    const notifyNoneRegistered = function() {
        gfgmsg.className = "alert alert-warning";
        gfgmsg.setAttribute('role', 'alert');
        gfgmsg.textContent = "The changes is not registered.";
    };

    const registereEvents = function() {
        [
            startDate,
            endDate,
            progress,
            dependencies 
        ].forEach((node, index) => {
            node.addEventListener('change', (e) => {
                notifyNoneRegistered();
            }, true);
        })
    };

    const clearAlert = function () {
        gfgmsg.className = "alert";
        gfgmsg.setAttribute('role', 'alert');
        gfgmsg.textContent = "";
    };

    const enterEditMode = function () {
        [
            [startDate, startDateText],
            [endDate, endDateText],
            [progress, progressText],
            [dependencies, dependenciesText]
        ].forEach((elem, index) => {
            elem[0].style.display = "inline-block";
            elem[1].style.display = "none";
        });
        gfgmsg.style.display = "inline-block";
        gfgpost.style.display = "inline-block";
        gfgcancel.style.display = "inline-block";
    };

    const cancelEditMode = function () {
        [
            [startDate, startDateText],
            [endDate, endDateText],
            [progress, progressText],
            [dependencies, dependenciesText]
        ].forEach((elem, index) => {
            elem[0].style.display = "none";
            elem[1].style.display = "inline-block";
            if (elem[1].textContent === "Not Set") {
                console.log(elem[0].tagName);
                if (elem[0].tagName === "SELECT") {
                    elem[0].value = "0";
                } else {
                    elem[0].value = "";
                }
            } else {
                elem[0].value = elem[1].textContent;
            }
        });
        gfgpost.style.display = "none";
        gfgcancel.style.display = "none";
        setTimeout(() => {
            gfgmsg.style.display = "none";
        }, 100000)
    };

    if (editgfg) {
        editgfg.addEventListener('click', (e) => enterEditMode(), false);
    }

    gfgpost.addEventListener('click', (e) => {
        const gfgmsg = document.querySelector("#gfg-msg");
        const form = document.getElementById("gfgform")
        const params = new URLSearchParams();
        params.append("startDate", document.querySelector("input[name='startDate']").value)
        params.append("endDate", document.querySelector("input[name='endDate']").value)
        params.append("progress", document.querySelector("select[name='progress']").value)
        params.append("dependencies", document.querySelector("input[name='dependencies']").value)
        const action = form.getAttribute("action")
        const options = {
            method: 'POST',
            body: params
        }
        fetch(action, options)
        .then((res) => {
            if(res.ok) {
                return res.json();
            } else {
                throw new Error("Registration failure");
            }
        })
        .then(data => {
            [
                [startDate, startDateText],
                [endDate, endDateText],
                [progress, progressText],
                [dependencies, dependenciesText]
            ].forEach((elem, index) => {
                elem[1].textContent = elem[0].value;
            });
            gfgmsg.className = "alert alert-success";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = data.message;
            setTimeout(() => clearAlert(), 10000);
            cancelEditMode();
        })
        .catch(e =>{
            gfgmsg.className = "alert alert-danger";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = e.message;
        });
    });

    gfgcancel.addEventListener('click', (e) => cancelEditMode(), false);

    document.addEventListener('DOMContentLoaded', (e) => {
        const url = "@context.path/@owner/@repositoryName/flexible-gantt/issues/@issueId"
        fetch(url)
        .then(res => {
            if (res.ok) {
                return res.json();
            }
        })
        .then(data =>{
            if (data.period.length == 0) return;
            var period = data.period[0];
            startDate.value = (new Date(Date.parse(period.startDate)))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            startDateText.textContent = startDate.value;
            endDate.value =  (new Date(Date.parse(period.endDate) - 1))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            endDateText.textContent = endDate.value;
            progress.value = period.progress;
            progressText.textContent = period.progress;
            dependencies.value = period.dependencies;
            dependenciesText.textContent = period.dependencies;
        })
        .finally(() => {
            registereEvents();
        })
    });
</script>