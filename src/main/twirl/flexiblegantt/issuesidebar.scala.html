@(
    owner: String,
    repositoryName: String,
    issueId: Int,
    isEditable: Boolean
)(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
<hr>
<div class="panel panel-default">
    <div class="panel-heading">
        <i class="menu-icon octicon octicon-dashboard"></i>Flexible Gantt
        @if(isEditable) {
            <div class="pull-right">
                <i id="edit-gfg" class="menu-icon octicon octicon-pencil"></i>
            </div>
        }
    </div>
    <div class="panel-body">
        <form method="post" id="gfgform" action="@context.path/@owner/@repositoryName/issues/@issueId/period">
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Start</span>
                <div class="pull-right">
                    <input type="date" name="startDate" class="form-control input-sm custom-field-editor" value="" style="display: none;">
                    <span id="startDateText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">End</span>
                <div class="pull-right">
                    <input type="date" name="endDate" class="form-control input-sm custom-field-editor" value="" style="display: none;">
                    <span id="endDateText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Progress</span>
                <div class="pull-right">
                    <select class="form-control input-sm custom-field-editor" name="progress" style="display: none;">
                        <option>0</option>
                        <option>10</option>
                        <option>20</option>
                        <option>30</option>
                        <option>40</option>
                        <option>50</option>
                        <option>60</option>
                        <option>70</option>
                        <option>80</option>
                        <option>90</option>
                        <option>100</option>
                    </select>
                    <span id="progressText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Dependencies</span>
                <div class="pull-right">
                    <input type="text" name="dependencies" maxlength="100" value="" style="display: none;">
                    <button id="refIssue" type="button" class="btn" data-toggle="modal" data-target="#issueListDialog" style="display: none;">
                        <i class="menu-icon octicon octicon-issue-opened"></i>
                    </button>
                    <span id="dependenciesText">Not Set</span>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <div class="pull-right">
                    <button class="btn btn-default btn-sm strong" id="gfgpost" type="button" style="display: none;">Update</button>
                    <button class="btn btn-default btn-sm strong" id="gfgcancel" type="button" style="display: none;">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div id="gfg-msg" class="alert" style="margin-bottom: 14px;"></div>
<div class="modal fade" id="issueListDialog" tabindex="-1">
    <div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span>Ã—</span></button>
				<h4 class="modal-title">Search issues</h4>
			</div>
			<div class="modal-body">
                <div>
                    <label>Search</label>
                    <input type="text" id="searchIssueText">
                    <button id="searchIssue" class="btn btn-default"><i class="menu-icon octicon octicon-search"></i>></i></button>
                </div>
                <div id="issueListBody" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc;">
                </div>
			</div>
			<div class="modal-footer">
				<button id="gfgUpdate" type="button" class="btn btn-primary">Update</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
    const editgfg = document.querySelector("#edit-gfg");
    const startDate = document.querySelector("input[name='startDate']");
    const startDateText = document.querySelector("#startDateText");
    const endDate = document.querySelector("input[name='endDate']");
    const endDateText = document.querySelector("#endDateText");
    const progress = document.querySelector("select[name='progress']");
    const progressText = document.querySelector("#progressText");
    const dependencies = document.querySelector("input[name='dependencies']");
    const dependenciesText = document.querySelector("#dependenciesText");
    const refIssue = document.querySelector("#refIssue");
    const gfgmsg = document.querySelector("#gfg-msg");
    const gfgpost = document.querySelector("#gfgpost");
    const gfgcancel = document.querySelector("#gfgcancel");
    const issueListBody = document.querySelector("#issueListBody");
    const searchIssue  = document.querySelector("#searchIssue");
    const searchIssueText  = document.querySelector("#searchIssueText");

    const notifyNoneRegistered = function() {
        gfgmsg.className = "alert alert-warning";
        gfgmsg.setAttribute('role', 'alert');
        gfgmsg.textContent = "The changes is not registered.";
    };

    const registereEvents = function() {
        [
            startDate,
            endDate,
            progress,
            dependencies 
        ].forEach((node, index) => {
            node.addEventListener('change', (e) => {
                notifyNoneRegistered();
            }, true);
        })
    };

    const clearAlert = function () {
        gfgmsg.className = "alert";
        gfgmsg.setAttribute('role', 'alert');
        gfgmsg.textContent = "";
    };

    const enterEditMode = function () {
        [
            [startDate, startDateText],
            [endDate, endDateText],
            [progress, progressText],
            [dependencies, dependenciesText]
        ].forEach((elem, index) => {
            elem[0].style.display = "inline-block";
            elem[1].style.display = "none";
        });
        refIssue.style.display = "inline-block";
        gfgpost.style.display = "inline-block";
        gfgcancel.style.display = "inline-block";
    };

    const cancelEditMode = function () {
        [
            [startDate, startDateText],
            [endDate, endDateText],
            [progress, progressText],
            [dependencies, dependenciesText]
        ].forEach((elem, index) => {
            elem[0].style.display = "none";
            elem[1].style.display = "inline-block";
            if (elem[1].textContent === "Not Set") {
                console.log(elem[0].tagName);
                if (elem[0].tagName === "SELECT") {
                    elem[0].value = "0";
                } else {
                    elem[0].value = "";
                }
            } else {
                elem[0].value = elem[1].textContent;
            }
        });
        refIssue.style.display = "none";
        gfgpost.style.display = "none";
        gfgcancel.style.display = "none";
        setTimeout(() => {
            clearAlert();
        }, 10000)
    };

    const getIssues = function() {
        const issueUrl = "@context.path/api/v3/repos/@owner/@repositoryName/issues";
        fetch(issueUrl)
        .then((res) =>{
            if(res.ok) {
                return res.json();
            } else {
                console.log(res);
            }
        })
        .then(data => {
            var currentIssue = parseInt("@issueId");
            data
            .filter((value, index) => {
                return value.number != currentIssue;
            })
            .sort((a, b) => a.number -b.number)
            .forEach((issue, index) => {
                if (issue.state === "open") {
                    var panel = document.createElement("div");
                    panel.classList.add("panel","panel-primary");
                    var panelBody = document.createElement("div");
                    panelBody.classList.add("panel-body");
                    var checkbox = document.createElement("input");
                    checkbox.setAttribute("type", "checkbox");
                    checkbox.setAttribute("data-id", issue.number);
                    panelBody.appendChild(checkbox);
                    var span = document.createElement("span");
                    span.textContent = `#${issue.number} ${issue.title}`;
                    panelBody.appendChild(span);
                    panel.appendChild(panelBody);
                    issueListBody.appendChild(panel);
                }
            });
        })
    };

    const showAllIssueListBody = function () {
        issueListBody.querySelectorAll(".panel").forEach((node, index) =>{
            node.style.display = "block";
        });
    };

    if (editgfg) {
        editgfg.addEventListener('click', (e) => enterEditMode(), false);
        refIssue.addEventListener('click', (e) => {
            if (dependencies.value.length > 0) {
                var idList = dependencies.value.split(",");
                issueListBody.querySelectorAll("input[type='checkbox']").forEach((node, index) =>{
                    var dataId = node.getAttribute("data-id");
                    node.checked = idList.includes(dataId);
                });
            } else {
                issueListBody.querySelectorAll("input[type='checkbox']").forEach((node, index) => {
                    node.checked = false;
                });
            }
        }, true)
        searchIssue.addEventListener('click', (e) => {
            var target = searchIssueText.value.toLowerCase();
            showAllIssueListBody();
            if (target.length > 0) {
                issueListBody.querySelectorAll(".panel").forEach((node, index) =>{
                    if (!node.querySelector("span").textContent.toLowerCase().includes(target)) {
                        node.style.display = "none";
                    }
                });
            } else {
                showAllIssueListBody();
            }
        }, true);
        document.querySelector("#gfgUpdate").addEventListener('click', (e) => {
            var idList = [];
            //issueListBody
            issueListBody.querySelectorAll("input[type='checkbox']").forEach((node, index) =>{
                if (node.checked) {
                    idList.push(node.getAttribute("data-id"));
                }
            });
            dependencies.value = idList.join(",");
            $('#issueListDialog').modal('hide'); 
        });
    }

    gfgpost.addEventListener('click', (e) => {
        const form = document.getElementById("gfgform")
        const params = new URLSearchParams();
        params.append("startDate", document.querySelector("input[name='startDate']").value)
        params.append("endDate", document.querySelector("input[name='endDate']").value)
        params.append("progress", document.querySelector("select[name='progress']").value)
        params.append("dependencies", document.querySelector("input[name='dependencies']").value)
        const action = form.getAttribute("action")
        const options = {
            method: 'POST',
            body: params
        }
        fetch(action, options)
        .then((res) => {
            if(res.ok) {
                return res.json();
            } else {
                throw new Error("Registration failure");
            }
        })
        .then(data => {
            [
                [startDate, startDateText],
                [endDate, endDateText],
                [progress, progressText],
                [dependencies, dependenciesText]
            ].forEach((elem, index) => {
                elem[1].textContent = elem[0].value;
            });
            gfgmsg.className = "alert alert-success";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = data.message;
            setTimeout(() => clearAlert(), 10000);
            cancelEditMode();
        })
        .catch(e =>{
            gfgmsg.className = "alert alert-danger";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = e.message;
        });
    });

    gfgcancel.addEventListener('click', (e) => {
        clearAlert();
        cancelEditMode();
    }, false);

    document.addEventListener('DOMContentLoaded', (e) => {
        const url = "@context.path/@owner/@repositoryName/flexible-gantt/issues/@issueId"
        getIssues();
        fetch(url)
        .then(res => {
            if (res.ok) {
                return res.json();
            }
        })
        .then(data =>{
            if (data.period.length == 0) return;
            var period = data.period[0];
            startDate.value = (new Date(Date.parse(period.startDate)))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            startDateText.textContent = startDate.value;
            endDate.value =  (new Date(Date.parse(period.endDate) - 1))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            endDateText.textContent = endDate.value;
            progress.value = period.progress;
            progressText.textContent = period.progress;
            dependencies.value = period.dependencies;
            dependenciesText.textContent = period.dependencies;
        })
        .finally(() => {
            registereEvents();
        })
    });
</script>