@(
    owner: String,
    repositoryName: String,
    issueId: Int,
    isEditable: Boolean
)(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><i class="menu-icon octicon octicon-dashboard"></i>Flexible Gantt</div>
    <div class="panel-body">
        <form method="post" id="gfgform" action="@context.path/@owner/@repositoryName/issues/@issueId/period">
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Start</span>
                <div class="pull-right"><input type="date" name="startDate" class="form-control input-sm custom-field-editor" value=""></div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">End</span>
                <div class="pull-right"><input type="date" name="endDate" class="form-control input-sm custom-field-editor" value=""></div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Progress</span>
                <div class="pull-right">
                    <select class="form-control input-sm custom-field-editor" name="progress">
                        <option>0</option>
                        <option>10</option>
                        <option>20</option>
                        <option>30</option>
                        <option>40</option>
                        <option>50</option>
                        <option>60</option>
                        <option>70</option>
                        <option>80</option>
                        <option>90</option>
                        <option>100</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <span class="muted small strong">Dependencies</span>
                <div class="pull-right"><input type="text" name="dependencies" maxlength="100" value=""></div>
            </div>
            <div id="gfg-msg" style="margin-bottom: 14px;"></div>
            <div style="margin-bottom: 14px;">
                <div class="pull-right">
                    <button class="btn btn-default btn-sm strong" id="gfgpost" type="button">Set</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    const notifyNoneRegistered = function() {
        const gfgmsg = document.querySelector("#gfg-msg");
        gfgmsg.className = "alert alert-warning";
        gfgmsg.setAttribute('role', 'alert');
        gfgmsg.textContent = "The changes is not registered.";
    };

    const registereEvents = function() {
        [
            document.querySelector("input[name='startDate']"),
            document.querySelector("input[name='endDate']"),
            document.querySelector("select[name='progress']"),
            document.querySelector("input[name='dependencies']")
        ].forEach((node, index) => {
            node.addEventListener('change', (e) => {
                notifyNoneRegistered();
            }, true);
        })
    };

    document.getElementById("gfgpost").addEventListener('click', (e) => {
        const gfgmsg = document.querySelector("#gfg-msg");
        const form = document.getElementById("gfgform")
        const params = new URLSearchParams();
        params.append("startDate", document.querySelector("input[name='startDate']").value)
        params.append("endDate", document.querySelector("input[name='endDate']").value)
        params.append("progress", document.querySelector("select[name='progress']").value)
        params.append("dependencies", document.querySelector("input[name='dependencies']").value)
        const action = form.getAttribute("action")
        const options = {
            method: 'POST',
            body: params
        }
        fetch(action, options)
        .then((res) => {
            if(res.ok) {
                return res.json();
            }
            gfgmsg.className = "alert alert-danger";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = res.message;
        })
        .then(data => {
            gfgmsg.className = "alert alert-success";
            gfgmsg.setAttribute('role', 'alert');
            gfgmsg.textContent = data.message;
        })
    })
    document.addEventListener('DOMContentLoaded', (e) => {
        const url = "@context.path/@owner/@repositoryName/flexible-gantt/issues/@issueId"
        fetch(url)
        .then(res => {
            if (res.ok) {
                return res.json();
            }
        })
        .then(data =>{
            if (data.period.length == 0) return;
            var period = data.period[0];
            document.querySelector("input[name='startDate']").value = (new Date(Date.parse(period.startDate)))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            document.querySelector("input[name='endDate']").value =  (new Date(Date.parse(period.endDate)))
                .toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-');
            document.querySelector("select[name='progress']").value = period.progress;
            document.querySelector("input[name='dependencies']").value = period.dependencies;
        })
        .finally(() => {
            registereEvents();
        })
    })
</script>