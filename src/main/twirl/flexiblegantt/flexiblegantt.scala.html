@(
    repository: gitbucket.core.service.RepositoryService.RepositoryInfo,
    milestoneId: Int,
    labelId: Int,
    isManageable: Boolean
)(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
@gitbucket.core.html.main("Flexible Gantt", Some(repository)) {
    @gitbucket.core.html.menu("gantt", repository) {
        <div id="gfg-menu" style="display: flex;">
            <nav class="navbar navbar-default" style="width: calc(100% - 90px); z-index: 2000;">
                <div class="navbar-header">
                    <a class="navbar-brand">Filter</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li>
                            <a class="btn btn-default" style="width: 100px;" role="button" href="@context.baseUrl/@repository.owner/@repository.name/flexible-gantt">All</a>
                        </li>
                        <li class="dropdown">
                            <a class="btn btn-default dropdown-toggle" style="width: 100px;" role="button" data-toggle="dropdown">
                                Milestone
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu" role="menu" id="milestones">
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a class="btn btn-default dropdown-toggle" style="width: 100px;" role="button" data-toggle="dropdown">
                                Labels
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu" role="menu" id="labels">
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="pull-right"><a class="btn btn-success" href="@context.baseUrl/@repository.owner/@repository.name/issues/new" style="margin-top: 6px;">New issue</a></div>
        </div>
        <div id="gfg-msg" class="alert"></div>
        <div class="container">
            <svg id="gantt" width="90%" height="90%"></svg>
        </div>
        @if(isManageable) {
            <script>var readonly = false;</script>
        } else {
            <script>var readonly = true;</script>
        }
        @if(milestoneId == 0 && labelId == 0) {
            <script>
                var taskUrl = "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/issues";
            </script>
        } else if (milestoneId > 0) {
            <script>
                var taskUrl = "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/issues/milestones/@milestoneId";
            </script>
        } else if (labelId > 0) {
            <script>
                var taskUrl = "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/issues/labels/@labelId";
            </script>
        }
        <script>
            const issuebase = "@context.baseUrl/@repository.owner/@repository.name/issues/";
            const postSuffix = "/period";

            const setSuccess = function (message) {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert alert-success";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = message;
                setTimeout(() => clearAlert(), 10000)
            };

            const setDanger = function (message) {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert alert-danger";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = message;
                setTimeout(() => clearAlert(), 10000)
            };

            const clearAlert = function () {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = "";
            };

            const setMilestones = function () {
                const milestones = document.querySelector("#milestones");
                const apiMilestonesUrl = "@context.baseUrl/api/v3/repos/@repository.owner/@repository.name/milestones";
                fetch(apiMilestonesUrl)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(data => {
                    data.forEach((elem, index) => {
                        if (elem.state === "open" && elem.open_issues > 0) {
                            var li = document.createElement("li");
                            li.setAttribute("role", "presentation");
                            var a = document.createElement("a");
                            a.textContent = elem.title;
                            a.setAttribute("href", "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/milestones/" + elem.id);
                            li.appendChild(a);
                            milestones.appendChild(li);
                        }
                    });
                });
            };

            const setLabels = function () {
                const labels = document.querySelector("#labels");
                const apiLabelsUrl = "@context.baseUrl/api/v3/repos/@repository.owner/@repository.name/labels";
                fetch(apiLabelsUrl)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(data => {
                    data.forEach((elem, index) => {
                        var li = document.createElement("li");
                        li.setAttribute("role", "presentation");
                        var a = document.createElement("a");
                        a.textContent = elem.name;
                        a.setAttribute("href", "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/labels/" + (index + 1));
                        li.appendChild(a);
                        labels.appendChild(li);
                    });
                });
            };

            function init() {
                setMilestones();
                setLabels();
                fetch(taskUrl)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(data => {
                    const tasks = data.list;
                    var gantt_chart = new Gantt("#gantt", tasks, {
                        on_click: function (task) {
                            window.open(issuebase + task.id)
                        },
                        on_date_change: function(task, start, end) {
                            var postUrl = issuebase + task.id + postSuffix;
                            const params = new URLSearchParams();
                            params.append("startDate", start.toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("endDate", end.toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("progress", task.progress);
                            params.append("dependencies", task.dependencies);
                            const options = {
                                method: 'POST',
                                body: params
                            };
                            fetch(postUrl, options)
                            .then((res) => {
                                if (res.ok) {
                                    return res.json();
                                } else {
                                    throw new Error("Registration failure");
                                }
                            })
                            .then((data) => {
                                setSuccess(data.message);
                            })
                            .catch((e) => {
                                setDanger(e.message);
                            });
                        },
                        on_progress_change: function(task, progress) {
                            var postUrl = issuebase + task.id + postSuffix;
                            const params = new URLSearchParams();
                            params.append("startDate", (new Date(task.start)).toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("endDate", (new Date(task.end)).toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("progress", progress);
                            params.append("dependencies", task.dependencies);
                            const options = {
                                method: 'POST',
                                body: params
                            };
                            fetch(postUrl, options)
                            .then((res) => {
                                if (res.ok) {
                                    return res.json();
                                } else {
                                    throw new Error("Registration failure");
                                }
                            })
                            .then((data) => {
                                setSuccess(data.message);
                            })
                            .catch((e) => {
                                setDanger(e.message);
                            });
                        },
                        on_view_change: function(mode) {
                            console.log(mode);
                        },
                        container_height: document.querySelector(".content-wrapper").clientHeight - 250,
                        popup_on: 'hover',
                        readonly: readonly,
                        view_mode_select: true,
                        language: 'ja'
                    })
                });
            }

            document.addEventListener("DOMContentLoaded", function() {
                init();
            }, false);
        </script>
    }
}
