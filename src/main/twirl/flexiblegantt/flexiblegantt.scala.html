@(
    repository: gitbucket.core.service.RepositoryService.RepositoryInfo
)(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
@gitbucket.core.html.main("Flexible Gantt", Some(repository)) {
    @gitbucket.core.html.menu("gantt", repository) {
        <div id="gfg-msg" class="alert"></div>
        <div class="container">
            <svg id="gantt" width="90%" height="90%"></svg>
        </div>
        <script>
            const issuebase = "@context.baseUrl/@repository.owner/@repository.name/issues/";
            const postSuffix = "/period";

            const setSuccess = function (message) {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert alert-success";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = message;
            };

            const setDanger = function (message) {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert alert-danger";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = message;
            };

            const clearAlert = function () {
                const gfgmsg = document.querySelector("#gfg-msg");
                gfgmsg.className = "alert";
                gfgmsg.setAttribute('role', 'alert');
                gfgmsg.textContent = "";
            };

            function init() {
                const url = "@context.baseUrl/@repository.owner/@repository.name/flexible-gantt/issues";
                fetch(url)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(data => {
                    const tasks = data.list;
                    var gantt_chart = new Gantt("#gantt", tasks, {
                        on_click: function (task) {
                            window.open(issuebase + task.id)
                        },
                        on_date_change: function(task, start, end) {
                            var postUrl = issuebase + task.id + postSuffix;
                            const params = new URLSearchParams();
                            params.append("startDate", start.toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("endDate", end.toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("progress", task.progress);
                            params.append("dependencies", task.dependencies);
                            const options = {
                                method: 'POST',
                                body: params
                            };
                            fetch(postUrl, options)
                            .then((res) => {
                                if (res.ok) {
                                    return res.json();
                                }
                                setDanger(e.message);
                                setTimeout(() => clearAlert(), 10000)
                            })
                            .then((data) => {
                                setSuccess(data.message);
                                setTimeout(() => clearAlert(), 10000)
                            });
                        },
                        on_progress_change: function(task, progress) {
                            var postUrl = issuebase + task.id + postSuffix;
                            const params = new URLSearchParams();
                            params.append("startDate", (new Date(task.start)).toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("endDate", (new Date(task.end) - 1).toLocaleDateString("ja-JP", {year: "numeric",month: "2-digit",  day: "2-digit"}).replaceAll('/', '-'));
                            params.append("progress", progress);
                            params.append("dependencies", task.dependencies);
                            const options = {
                                method: 'POST',
                                body: params
                            };
                            fetch(postUrl, options)
                            .then((res) => {
                                if (res.ok) {
                                    return res.json();
                                }
                                setDanger(e.message);
                                setTimeout(() => clearAlert(), 10000)
                            })
                            .then((data) => {
                                setSuccess(data.message);
                                setTimeout(() => clearAlert(), 10000)
                            });
                        },
                        on_view_change: function(mode) {
                            console.log(mode);
                        },
                        container_height: document.querySelector(".content-wrapper").clientHeight - 150,
                        popup_on: 'hover',
                        view_mode_select: true,
                        language: 'ja'
                    })
                });
            }

            document.addEventListener("DOMContentLoaded", function() {
                init();
            }, false);
        </script>
    }
}
